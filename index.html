<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>WebIM-DEMO</title>

<script>
    function __log(e, data) {
        console.log("\n" + e + " " + (data || ''));
    }

    var audio_context;
    var recorder;

    function startUserMedia(stream) {
        var input = audio_context.createMediaStreamSource(stream);
        __log('Media stream created.' );
        __log("input sample rate " +input.context.sampleRate);

        input.connect(audio_context.destination);
        __log('Input connected to audio context destination.');

        recorder = new Recorder(input);
        __log('Recorder initialised.');
    }

    function startRecording(button) {
        recorder && recorder.record();
        $(this).html('发送语音');
        $(this).unbind().mouseup(stopRecording);
        __log('Recording...');
    }

    function stopRecording(button) {
        recorder && recorder.stop();
        $(this).html('点我发送语音');
        $(this).unbind().mousedown(startRecording);
        __log('Stopped recording.');

// create WAV download link using audio data blob
        createDownloadLink();

        recorder.clear();
    }


    function createDownloadLink() {
        recorder && recorder.exportWAV(function(blob) {
            console.log('starting to convert');
        });
    }



    window.onload = function init() {
        try {
            // webkit shim
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            navigator.getUserMedia = ( navigator.getUserMedia ||
                    navigator.webkitGetUserMedia ||
                    navigator.mozGetUserMedia ||
                    navigator.msGetUserMedia);
            window.URL = window.URL || window.webkitURL;

            audio_context = new AudioContext;
            __log('Audio context set up.');
            __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
        } catch (e) {
            $('#voice-record').remove();
            alert('No web audio support in this browser!');
        }

        navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
            __log('No live audio input: ' + e);
        });
    };
</script>

<script type="text/javascript" src="bower_components/underscore/underscore.js"></script>

<script type="text/javascript" src="bower_components/jquery/jquery.min.js"></script>
<script type="text/javascript" src="bower_components/jquery-cookie/jquery.cookie.js"></script>


<script type='text/javascript' src='bower_components/strophe/strophe.min.js'></script>
<script type="text/javascript" src="bower_components/json2/json2.js"></script>
<script type="text/javascript" src="js/easemob.xmpp-1.0.0.js"></script>
<script src="js/recordmp3.js"></script>

<script type="text/javascript" src="bower_components/bootstrap/docs/assets/js/bootstrap.min.js"></script>

<link rel="stylesheet" type="text/css" href="css/webim.css" />
<link rel="stylesheet" type="text/css" href="bower_components/bootstrap/docs/assets/css/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="bower_components/bootstrap/docs/assets/css/bootstrap-responsive.css" />

<script src="bower_components/amr/lib/pcmdata.min.js"></script>
<!-- Development -->
<script src="bower_components/amr/dist/amrnb.min.js"></script>
<script src="bower_components/amr/src/util.js"></script>
<script src="bower_components/amr/src/amr.js"></script>
<script src="bower_components/amr/src/decoder.js"></script>
<script src="bower_components/amr/src/encoder.js"></script>

<script src="js/io.js"></script>

<script type="text/javascript">
var APP_KEY = "okchexian#okchexian";

var curUserId = null;
var curChatUserId = null;
var conn = null;
var curRoomId = null;
var msgCardDivId = "chat01";
var talkToDivId = "talkTo";
var talkInputId = "talkInputId";
var fileInputId = "fileInput";
var bothRoster = [];
var fromRoster = [];
var toRoster = [];
var unknowContact = {};
var maxWidth = 200;
var listRoom = [];
var listRoomId = [];
var curContentTypeFlag = null;
var modal_template = '<div id="confirm-block-div-modal-<%= id %>" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">\
        <div class="modal-header">\
        <h3>订阅通知</h3>\
</div>\
<div class="modal-body">\
        <div id="confirm-block-footer-body"><%= msg %></div>\
</div>\
<div class="modal-footer">\
        <button id="confirm-block-footer-confirmButton"\
class="btn btn-primary">同意</button>\
<button id="confirm-block-footer-cancelButton" class="btn"\
data-dismiss="modal">拒绝</button>\
</div>\
</div>';

window.URL = window.URL || window.webkitURL || window.mozURL
        || window.msURL;

var showLoginUI = function() {
    $('#loginmodal').modal('show');
    $('#username').focus();
};
var hiddenLoginUI = function() {
    $('#loginmodal').modal('hide');
};
var showWaitLoginedUI = function() {
    $('#waitLoginmodal').modal('show');
};
var hiddenWaitLoginedUI = function() {
    $('#waitLoginmodal').modal('hide');
};
var showChatUI = function() {
    $('#content').css({
        "display" : "block"
    });
    document.getElementById("login_user").children[0].innerHTML = curUserId;
};
//登录之前不显示web对话框
var hiddenChatUI = function() {
    $('#content').css({
        "display" : "none"
    });
    document.getElementById(talkInputId).value = "";
};
//定义消息编辑文本域的快捷键，enter和ctrl+enter为发送，alt+enter为换行
$(function() {
    $("textarea").keydown(function(event) {

        if (event.altKey && event.keyCode == 13) {
            e = $(this).val();
            $(this).val(e + '\n');
        } else if (event.ctrlKey && event.keyCode == 13) {
            //e = $(this).val();
            //$(this).val(e + '<br>');
            event.returnValue = false;
            sendText();
            return false;
        } else if (event.keyCode == 13) {
            event.returnValue = false;
            sendText();
            return false;
        }

    });
});

var is_login = function(){
    if($.cookie('im.user') != undefined && $.cookie('im.pass') != undefined){
        auto_login({user: $.cookie('im.user'),pass: $.cookie('im.pass')})
    }else{
        showLoginUI();
    }
}

//easemobwebim-sdk注册回调函数列表
$(document).ready(function() {
    conn = new Easemob.xmpp.Connection();
    //初始化连接
    conn.init({
        //当连接成功时的回调方法
        onOpened : function() {
            handleOpen(conn);
        },
        //当连接关闭时的回调方法
        onClosed : function() {
            handleClosed();
        },
        //收到文本消息时的回调方法
        onTextMessage : function(message) {
            handleTextMessage(message);
        },
        //收到表情消息时的回调方法
        onEmotionMessage : function(message) {
            handleEmotion(message);
        },
        //收到图片消息时的回调方法
        onPictureMessage : function(message) {
            handlePictureMessage(message);
        },
        //收到音频消息的回调方法
        onAudioMessage : function(message) {
            handleAudioMessage(message);
        },
        onLocationMessage : function(message) {
            handleLocationMessage(message);
        },
        //收到联系人订阅请求的回调方法
        onPresence : function(message) {
            handlePresence(message);
        },
        //收到联系人信息的回调方法
        onRoster : function(message) {
            handleRoster(message);
        },
        //异常时的回调方法
        onError : function(message) {
            handleError(message);
        }
    });


    is_login();

    //发送文件的模态窗口
    $('#fileModal').on('hidden.bs.modal', function(e) {
        var ele = document.getElementById(fileInputId);
        ele.value = "";
        if (!window.addEventListener) {
            ele.outerHTML = ele.outerHTML;
        }
        document.getElementById("fileSend").disabled = false;
        document.getElementById("cancelfileSend").disabled = false;
    });

    $('#addFridentModal').on('hidden.bs.modal', function(e) {
        var ele = document.getElementById("addfridentId");
        ele.value = "";
        if (!window.addEventListener) {
            ele.outerHTML = ele.outerHTML;
        }
        document.getElementById("addFridend").disabled = false;
        document.getElementById("cancelAddFridend").disabled = false;
    });

    $('#delFridentModal').on('hidden.bs.modal', function(e) {
        var ele = document.getElementById("delfridentId");
        ele.value = "";
        if (!window.addEventListener) {
            ele.outerHTML = ele.outerHTML;
        }
        document.getElementById("delFridend").disabled = false;
        document.getElementById("canceldelFridend").disabled = false;
    });

    $('#confirm-block-div-modal').on('hidden.bs.modal', function(e) {

    });

    $('#option-room-div-modall').on('hidden.bs.modal', function(e) {

    });

    //在 密码输入框时的回车登录
    $('#password').keypress(function(e) {
        var key = e.which;
        if (key == 13) {
            login();
        }
    });

    $(function() {
        $(window).bind('beforeunload', function() {
            if (conn) {
                conn.close();
            }
            return true;
        });
    });
});

//处理连接时函数,主要是登录成功后对页面元素做处理
var handleOpen = function(conn) {
    //从连接中获取到当前的登录人注册帐号名
    curUserId = conn.context.userId;
    //获取当前登录人的联系人列表
    conn.getRoster({
        success : function(roster) {
            hiddenWaitLoginedUI();// 页面处理
            showChatUI();
            var curroster;
            for ( var i in roster) {
                var ros = roster[i];
                //both为双方互为好友，要显示的联系人,from我是对方的单向好友
                if (ros.subscription == 'both'
                        || ros.subscription == 'from') {
                    bothRoster.push(ros);
                } else if (ros.subscription == 'to') {
                    //to表明了联系人是我的单向好友
                    toRoster.push(ros);
                }
            }
            if (bothRoster.length > 0) {
                curroster = bothRoster[0];
                buildContactDiv("contractlist", bothRoster);//联系人列表页面处理
                if (curroster)
                    setCurrentContact(curroster.name);//页面处理将第一个联系人作为当前聊天div
            }
            conn.setPresence();
            //获取当前登录人的群组列表
            conn.listRooms({
                success : function(rooms) {
                    if (rooms) {
                        var listRoom = rooms;
                        buildListRoomDiv("contractlist", rooms);//群组列表页面处理
                    }
                },
                error : function(e) {

                }
            });
        },
    });

};

//连接中断时的处理，主要是对页面进行处理
var handleClosed = function() {
    curUserId = null;
    curChatUserId = null;
    curRoomId = null;
    bothRoster = [];
    fromRoster = [];
    toRoster = [];
    listRoom = [];
    listRoomId = [];
    hiddenChatUI();
    clearContactUI("contractlist", msgCardDivId);
    unknowContact = {};
    showLoginUI();
};
//easemobwebim-sdk中收到联系人订阅请求的处理方法，具体的type值所对应的值请参考xmpp协议规范
var handlePresence = function(e) {
    //（发送者希望订阅接收者的出席信息），即别人申请加你为好友
    if (e.type == 'subscribe') {
        if (e.status) {
            if (e.status.indexOf('resp:true') > -1) {
                agreeAddFriend(conn, e.from);
                return;
            }
        }
        var subscribeMessage = e.from + "请求加你为好友。\n验证消息：" + e.status;

        var _modal = showNewNotice(subscribeMessage, e.from);
        _modal.find('#confirm-block-footer-confirmButton').click(function() {
            //同意好友请求
            agreeAddFriend(conn, e.from);//e.from用户名
            //反向添加对方好友
            conn.subscribe({
                to : e.from,
                message : "[resp:true]"
            });
            _modal.modal('hide');
            _modal.remove();


            is_login();


        });
        _modal.find('#confirm-block-footer-cancelButton').click(function() {
            rejectAddFriend(conn, e.from);//拒绝加为好友
            _modal.modal('hide');
            _modal.remove();
        });
        return;
    }
    //(发送者允许接收者接收他们的出席信息)，即别人同意你加他为好友
    if (e.type == 'subscribed') {
        toRoster.push({
            name : e.from,
            jid : e.fromJid,
            subscription : "to"
        });
        return;
    }
    //（发送者取消订阅另一个实体的出席信息）,即删除现有好友
    if (e.type == 'unsubscribe') {
        //单向删除自己的好友信息，具体使用时请结合具体业务进行处理
        delFriend(conn, e.from);
        return;
    }
    //（订阅者的请求被拒绝或以前的订阅被取消），即对方单向的删除了好友
    if (e.type == 'unsubscribed') {
        delFriend(conn, e.from);
        return;
    }
};
//easemobwebim-sdk中处理出席状态操作
var handleRoster = function(rosterMsg) {
    for ( var i = 0; i < rosterMsg.length; i++) {
        var contact = rosterMsg[i];
        if (contact.ask && contact.ask == 'subscribe') {
            continue;
        }
        if (contact.subscription == 'to') {
            toRoster.push({
                name : contact.name,
                jid : contact.jid,
                subscription : "to"
            });
        }
        //app端删除好友后web端要同时判断状态from做删除对方的操作
        if (contact.subscription == 'from') {
            toRoster.push({
                name : contact.name,
                jid : contact.jid,
                subscription : "from"
            });
        }
        if (contact.subscription == 'both') {
            var isexist = contains(bothRoster, contact);
            if (!isexist) {
                var newcontact = document.getElementById("contactlistUL");
                var lielem = document.createElement("li");
                lielem.setAttribute("id", contact.name);
                lielem.setAttribute("class", "offline");
                lielem.setAttribute("className", "offline");
                lielem.onclick = function() {
                    chooseContactDivClick(this);
                };
                var imgelem = document.createElement("img");
                imgelem.setAttribute("src", "img/head/contact_normal.png");
                lielem.appendChild(imgelem);

                var spanelem = document.createElement("span");
                spanelem.innerHTML = contact.name;
                lielem.appendChild(spanelem);

                newcontact.appendChild(lielem);
                bothRoster.push(contact);
            }
        }
        if (contact.subscription == 'remove') {
            var isexist = contains(bothRoster, contact);
            if (isexist) {
                var newcontact = document.getElementById("contactlistUL");
                bothRoster.remove(contact);//联系人删除操作
                //退出后重新登录后显示
                var childs = newcontact.childNodes;
                for ( var i = childs.length - 1; i >= 0; i--) {
                    if (childs[i].id == contact.name) {
                        newcontact.removeChild(childs[i]);
                        if (curChatUserId == contact.name) {
                            if (bothRoster.length >= 0) {
                                buildContactDiv("contractlist", bothRoster);//页面处理
                                if (bothRoster.length > 0) {
                                    setCurrentContact(bothRoster[0].name);//页面处理将第一个联系人作为当前聊天div
                                }
                            }
                        }
                    }
                }
            }

        }
    }
};
//异常情况下的处理方法
var handleError = function(e) {
    if (curUserId == null) {
        hiddenWaitLoginedUI();
        alert(e.msg + ",请重新登录");
        showLoginUI();
    } else {
        var msg = e.msg;
        if (e.type == EASEMOB_XMPP_CONNCTION_SERVER_CLOSE_ERROR) {
            if (msg == "") {
                alert("服务器器断开连接,可能是因为在别处登录");
            } else {
                alert("服务器器断开连接");
            }
        } else {
            alert(msg);
        }
    }
};
//判断要操作的联系人和当前联系人列表的关系
var contains = function(roster, contact) {
    var i = roster.length;
    while (i--) {
        if (roster[i].name === contact.name) {
            return true;
        }
    }
    return false;
};

Array.prototype.indexOf = function(val) {
    for ( var i = 0; i < this.length; i++) {
        if (this[i].name == val.name)
            return i;
    }
    return -1;
};
Array.prototype.remove = function(val) {
    var index = this.indexOf(val);
    if (index > -1) {
        this.splice(index, 1);
    }
};

//登录系统时的操作方法
var login = function() {
    var user = $("#username").val();
    var pass = $("#password").val();
    if (user == '' || pass == '') {
        alert("请输入用户名和密码");
        return;
    }
    hiddenLoginUI();
    showWaitLoginedUI();
    //根据用户名密码登录系统
    conn.open({
        user : user,
        pwd : pass,
        //连接时提供appkey

        appKey : APP_KEY,
    });
    return false;
};
//登录系统时的操作方法
var auto_login = function(options) {
    var user = innerBase64.decode(options.user);
    var pass = innerBase64.decode(options.pass);
    if (user == '' || pass == '') {
        $.removeCookie('im.user');
        $.removeCookie('im.pass');
        showLoginUI();
        return;
    }
    hiddenLoginUI();
    showWaitLoginedUI();
    //根据用户名密码登录系统
    conn.open({
        user : user,
        pwd : pass,
        //连接时提供appkey
        appKey : APP_KEY,
    });
    return false;
};
var logout = function() {
    $.removeCookie('im.user');
    $.removeCookie('im.pass');

    conn.close();
};

//设置当前显示的聊天窗口div，如果有联系人则默认选中联系人中的第一个联系人，如没有联系人则当前div为null-nouser
var setCurrentContact = function(defaultUserId) {
    showContactChatDiv(defaultUserId);
    if (curChatUserId != null) {
        hiddenContactChatDiv(curChatUserId);
    } else {
        $('#null-nouser').css({
            "display" : "none"
        });
    }
    curChatUserId = defaultUserId;
};
//构造联系人列表
var buildContactDiv = function(contactlistDivId, roster) {
    var uielem = document.createElement("ul");
    uielem.setAttribute("id", "contactlistUL");
    uielem.setAttribute("class", "chat03_content_ul");
    var cache = {};
    for (i = 0; i < roster.length; i++) {
        if (!(roster[i].subscription == 'both' || roster[i].subscription == 'from')) {
            continue;
        }
        var jid = roster[i].jid;
        var userName = jid.substring(jid.indexOf("_") + 1).split("@")[0];
        if (userName in cache) {
            continue;
        }
        cache[userName] = true;
        var lielem = document.createElement("li");
        lielem.setAttribute("id", userName);
        lielem.setAttribute("class", "offline");
        lielem.setAttribute("className", "offline");
        lielem.setAttribute("chat", "chat");
        lielem.setAttribute("displayName", userName);
        lielem.onclick = function() {
            chooseContactDivClick(this);
        };
        var imgelem = document.createElement("img");
        imgelem.setAttribute("src", "img/head/contact_normal.png");
        lielem.appendChild(imgelem);

        var spanelem = document.createElement("span");
        spanelem.innerHTML = userName;
        lielem.appendChild(spanelem);

        uielem.appendChild(lielem);
    }
    var contactlist = document.getElementById(contactlistDivId);
    var children = contactlist.children;
    if (children.length > 0) {
        contactlist.removeChild(children[0]);
    }
    contactlist.appendChild(uielem);
};

//构造群组列表
buildListRoomDiv = function(contactlistDivId, rooms) {
    var uielem = document.getElementById("contactlistUL");
    var cache = {};
    for (i = 0; i < rooms.length; i++) {
        var roomsName = rooms[i].name;
        var roomId = rooms[i].roomId;
        listRoomId.push(roomId);
        if (roomId in cache) {
            continue;
        }
        cache[roomId] = true;
        var lielem = document.createElement("li");
        $(lielem).attr({
            'id' : 'group&-' + roomId,
            'class' : 'offline',
            'className' : 'offline',
            'type' : 'groupchat',
            'displayName' : roomsName,
            'roomId' : roomId,
            'joined' : 'false'
        });
        $(lielem).click(function() {
            chooseContactDivClick(this);
        });
        $(lielem).append('<img src="img/head/group_normal.png"/>');
        $(lielem).append('<span>' + roomsName + '<span>');

        uielem.appendChild(lielem);
    }
    var contactlist = document.getElementById(contactlistDivId);
    var children = contactlist.children;
    if (children.length > 0) {
        contactlist.removeChild(children[0]);
    }
    contactlist.appendChild(uielem);
};

//选择联系人的处理
var getContactLi = function(chatUserId) {
    var li = document.getElementById(chatUserId);
    return li;
};

//构造当前聊天记录的窗口div
var getContactChatDiv = function(chatUserId) {
    var msgContentDivId = curUserId + "-" + chatUserId;
    var contentDiv = document.getElementById(msgContentDivId);
    return contentDiv;
};

//如果当前没有某一个联系人的聊天窗口div就新建一个
var createContactChatDiv = function(chatUserId) {
    var msgContentDivId = curUserId + "-" + chatUserId;
    var newContent = document.createElement("div");
    newContent.setAttribute("id", msgContentDivId);
    newContent.setAttribute("class", "chat01_content");
    newContent.setAttribute("className", "chat01_content");
    newContent.setAttribute("style", "display:none");
    return newContent;
};

//显示当前选中联系人的聊天窗口div，并将该联系人在联系人列表中背景色置为蓝色
var showContactChatDiv = function(chatUserId) {
    var contentDiv = getContactChatDiv(chatUserId);
    if (contentDiv == null) {
        contentDiv = createContactChatDiv(chatUserId);
        document.getElementById(msgCardDivId).appendChild(contentDiv);
    }
    contentDiv.style.display = "block";
    var contactLi = document.getElementById(chatUserId);
    if (contactLi == null) {
        return;
    }
    contactLi.style.backgroundColor = "blue";
    var dispalyTitle = null;//聊天窗口显示当前对话人名称
    if (chatUserId.indexOf("group&-") >= 0) {
        dispalyTitle = "群组" + $(contactLi).attr('displayname') + "聊天中";
        curRoomId = $(contactLi).attr('roomid');
        $("#roomMemberImg").css('display', 'block');
    } else {
        dispalyTitle = "与" + chatUserId + "聊天中";
        $("#roomMemberImg").css('display', 'none');
    }

    document.getElementById(talkToDivId).children[0].innerHTML = dispalyTitle;
};
//对上一个联系人的聊天窗口div做隐藏处理，并将联系人列表中选择的联系人背景色置空
var hiddenContactChatDiv = function(chatUserId) {
    var contactLi = document.getElementById(chatUserId);
    if (contactLi) {
        contactLi.style.backgroundColor = "";
    }
    var contentDiv = getContactChatDiv(chatUserId);
    if (contentDiv) {
        contentDiv.style.display = "none";

    }

};
//切换联系人聊天窗口div
var chooseContactDivClick = function(li) {
    var chatUserId = li.id;
    if ($(li).attr("type") == 'groupchat' && ('true' != $(li).attr("joined"))) {
        conn.join({
            roomId : $(li).attr("roomId")
        });
        $(li).attr("joined", "true");
    }
    if (chatUserId != curChatUserId) {
        if (curChatUserId == null) {
            showContactChatDiv(chatUserId);
        } else {
            showContactChatDiv(chatUserId);
            hiddenContactChatDiv(curChatUserId);
        }
        curChatUserId = chatUserId;
    }
    //对默认的null-nouser div进行处理,走的这里说明联系人列表肯定不为空所以对默认的聊天div进行处理
    $('#null-nouser').css({
        "display" : "none"
    });
};

var clearContactUI = function(contactInfoDiv, contactChatDiv) {
    document.getElementById(talkToDivId).children[0].innerHTML = "";
    var contactlist = document.getElementById(contactInfoDiv);
    var children = contactlist.children;
    if (children.length > 0) {
        contactlist.removeChild(children[0]);
    }
    var chatRootDiv = document.getElementById(contactChatDiv);
    var children = chatRootDiv.children;
    for ( var i = children.length - 1; i > 1; i--) {
        chatRootDiv.removeChild(children[i]);
    }
    $('#null-nouser').css({
        "display" : "block"
    });
};
var emotionFlag = false;
var showEmotionDialog = function() {
    if (emotionFlag) {
        $('#wl_faces_box').css({
            "display" : "block"
        });
        return;
    }
    ;
    emotionFlag = true;
    // Easemob.xmpp.Helper.EmotionPicData设置表情的json数组
    var sjson = Easemob.xmpp.Helper.EmotionPicData;
    for ( var key in sjson) {
        var emotionImgContent = document.createElement("img");
        emotionImgContent.setAttribute("id", key);
        emotionImgContent.setAttribute("src", sjson[key]);
        emotionImgContent.setAttribute("style", "cursor:pointer;");
        emotionImgContent.onclick = function() {
            selectEmotionImg(this);
        };
        var emotionLi = document.createElement("li");
        emotionLi.appendChild(emotionImgContent);
        document.getElementById("emotionUL").appendChild(emotionLi);
    }
    $('#wl_faces_box').css({
        "display" : "block"
    });
};
//表情选择div的关闭方法
var turnoffFaces_box = function() {
    $("#wl_faces_box").fadeOut("slow");
};
var selectEmotionImg = function(selImg) {
    var txt = document.getElementById(talkInputId);
    txt.value = txt.value + selImg.id;
    txt.focus();
};
var showSendPic = function() {
    $('#fileModal').modal('toggle');
    $('#sendfiletype').val('pic');
    $('#send-file-warning').html("");
};
var showSendAudio = function() {
    $('#fileModal').modal('toggle');
    $('#sendfiletype').val('audio');
    $('#send-file-warning').html("");
};
var sendText = function() {
    var msgInput = document.getElementById(talkInputId);
    var msg = msgInput.value;

    if (msg == null || msg.length == 0) {
        return;
    }
    var to = curChatUserId;
    if (to == null) {
        //alert("请选择联系人");
        $('#')
        return;
    }
    // 群组消息和个人消息的判断分支
    if (curChatUserId.indexOf("group&-") >= 0) {
        conn.sendRoomMsg({
            msgtype : 'txt',
            roomId : curRoomId,
            msg : msg
        });
    } else {
        //easemobwebim-sdk发送文本消息的方法 to为发送给谁，meg为文本消息对象
        conn.sendTextMessage({
            to : to,
            msg : msg
        });
    }

    //当前登录人发送的信息在聊天窗口中原样显示
    var msgtext = msg.replace(/\n/g, '<br>');
    appendMsg(curUserId, to, msgtext);
    turnoffFaces_box();
    msgInput.value = "";
    msgInput.focus();
};
var pictype = {
    "jpg" : true,
    "gif" : true,
    "png" : true,
    "bmp" : true
};
var sendFile = function() {
    var type = $("#sendfiletype").val();
    if (type == 'pic') {
        sendPic();
    } else {
        sendAudio();
    }
};
//发送图片消息时调用方法
var sendPic = function() {
    var to = curChatUserId;
    if (to == null) {
        //alert("请选择联系人");
        return;
    }
    // Easemob.xmpp.Helper.getFileUrl为easemobwebim-sdk获取发送文件对象的方法，fileInputId为 input 标签的id值
    var fileObj = Easemob.xmpp.Helper.getFileUrl(fileInputId);
    if (fileObj.url == null || fileObj.url == '') {
        //alert("请选择发送图片");
        $('#send-file-warning')
                .html("<font color='#FF0000'>请选择发送图片</font>");
        return;
    }
    var filetype = fileObj.filetype;
    var filename = fileObj.filename;
    if (filetype in pictype) {
        document.getElementById("fileSend").disabled = true;
        document.getElementById("cancelfileSend").disabled = true;
        var opt = {
            fileInputId : fileInputId,
            to : to,
            onFileUploadError : function(error) {
                $('#fileModal').modal('hide');
                var messageContent = error.msg + ",发送图片文件失败:" + filename;
                appendMsg(curUserId, to, messageContent);
            },
            onFileUploadComplete : function(data) {
                $('#fileModal').modal('hide');
                var file = document.getElementById(fileInputId);
                if (file && file.files) {
                    var objUrl = getObjectURL(file.files[0]);
                    if (objUrl) {
                        var img = document.createElement("img");
                        img.src = objUrl;
                        img.width = maxWidth;
                    }
                }
                appendMsg(curUserId, to, {
                    data : [ {
                        type : 'pic',
                        filename : filename,
                        data : img
                    } ]
                });
            }
        };
        if (curChatUserId.indexOf("group&-") >= 0) {
            opt.roomId = curRoomId;
            opt.msgtype = 'img';
            conn.sendRoomMsg(opt);
        } else {
            conn.sendPicture(opt);
        }
        return;
    }
    //alert("不支持此图片类型" + filetype);
    $('#send-file-warning').html(
                    "<font color='#FF0000'>不支持此图片类型" + filetype + "</font>");
};
var audtype = {
    "mp3" : true,
    "wma" : true,
    "wav" : true,
    "amr" : true,
    "avi" : true
};
//发送音频消息时调用的方法
var sendAudio = function() {
    var to = curChatUserId;
    if (to == null) {
        alert("请选择联系人");
        return;
    }
    //利用easemobwebim-sdk提供的方法来构造一个file对象
    var fileObj = Easemob.xmpp.Helper.getFileUrl(fileInputId);
    if (fileObj.url == null || fileObj.url == '') {
        //alert("请选择发送音频");
        $('#send-file-warning')
                .html("<font color='#FF0000'>请选择发送音频</font>");
        return;
    }
    var filetype = fileObj.filetype;
    var filename = fileObj.filename;
    if (filetype in audtype) {
        document.getElementById("fileSend").disabled = true;
        document.getElementById("cancelfileSend").disabled = true;
        var opt = {
            fileInputId : fileInputId,
            to : to,//发给谁
            onFileUploadError : function(error) {
                $('#fileModal').modal('hide');
                var messageContent = error.msg + ",发送音频失败:" + filename;
                appendMsg(curUserId, to, messageContent);
            },
            onFileUploadComplete : function(data) {
                var messageContent = "发送音频" + filename;
                $('#fileModal').modal('hide');
                appendMsg(curUserId, to, messageContent);
            }
        };
        //构造完opt对象后调用easemobwebim-sdk中发送音频的方法
        if (curChatUserId.indexOf("group&-") >= 0) {
            opt.roomId = curRoomId;
            opt.msgtype = 'audio';
            conn.sendRoomMsg(opt);
        } else {
            conn.sendAudio(opt);
        }
        return;
    }
    //alert("不支持此音频类型" + filetype);
    $('#send-file-warning').html(
                    "<font color='#FF0000'>不支持此音频类型" + filetype + "</font>");
};
//easemobwebim-sdk收到文本消息的回调方法的实现
var handleTextMessage = function(message) {
    var from = message.from;//消息的发送者
    var mestype = message.type;//消息发送的类型是群组消息还是个人消息
    var messageContent = message.data;//文本消息体
    //TODO  根据消息体的to值去定位那个群组的聊天记录
    var room = message.to;
    if (mestype == 'groupchat') {
        appendMsg(message.from, message.to, messageContent, mestype);
    } else {
        appendMsg(from, from, messageContent);
    }
};
//easemobwebim-sdk收到表情消息的回调方法的实现，message为表情符号和文本的消息对象，文本和表情符号sdk中做了
//统一的处理，不需要用户自己区别字符是文本还是表情符号。
var handleEmotion = function(message) {
    var from = message.from;
    var room = message.to;
    var mestype = message.type;//消息发送的类型是群组消息还是个人消息
    if (mestype == 'groupchat') {
        appendMsg(message.from, message.to, message, mestype);
    } else {
        appendMsg(from, from, message);
    }

};
//easemobwebim-sdk收到图片消息的回调方法的实现
var handlePictureMessage = function(message) {
    var filename = message.filename;//文件名称，带文件扩展名
    var from = message.from;//文件的发送者
    var mestype = message.type;//消息发送的类型是群组消息还是个人消息

    var contactDivId = message.from;   //TODO to 改为 from

    var displayName = message.from;
    if (mestype == 'groupchat') {
        contactDivId = "group&-" + contactDivId;
        displayName = from;
    }
    //测试提出两条消息，注释掉处理消息 0703
    //var ele = appendMsg(from, from, "收到图片" + filename + ",正在处理");//在聊天记录中处理记录显示的统一方法
    //if (ele == null) {
    //	return;
    //}
    var options = message;
    // 图片消息下载成功后的处理逻辑
    options.onFileDownloadComplete = function(response, xhr) {
        var objectURL = window.URL.createObjectURL(response);
        img = document.createElement("img");
        img.onload = function(e) {
            img.onload = null;
            window.URL.revokeObjectURL(img.src);
        };
        img.onerror = function() {
            img.onerror = null;
            if (typeof FileReader == 'undefined') {
                img.alter = "当前浏览器不支持blob方式";
                return;
            }
            img.onerror = function() {
                img.alter = "当前浏览器不支持blob方式";
            };
            var reader = new FileReader();
            reader.onload = function(event) {
                img.src = this.result;
            };
            reader.readAsDataURL(response);
        }
        img.src = objectURL;
        var pic_real_width = options.width;

        if (pic_real_width == 0) {
            $("<img/>").attr("src", objectURL).load(function() {
                pic_real_width = this.width;
                if (pic_real_width > maxWidth) {
                    img.width = maxWidth;
                } else {
                    img.width = pic_real_width;
                }
                appendMsg(displayName, contactDivId, {

                    data : [ {
                        type : 'pic',
                        filename : filename,
                        data : img
                    } ]
                });

            });
        } else {
            if (pic_real_width > maxWidth) {
                img.width = maxWidth;
            } else {
                img.width = pic_real_width;
            }
            appendMsg(displayName, contactDivId, {
                data : [ {
                    type : 'pic',
                    filename : filename,
                    data : img
                } ]
            });
        }
    };
    options.onFileDownloadError = function(e) {
        appendMsg(contactDivId, contactDivId, e.msg + ",下载图片" + filename
                + "失败");
    };
    //easemobwebim-sdk包装的下载文件对象的统一处理方法。
    Easemob.xmpp.Helper.download(options);
};
//easemobwebim-sdk收到音频消息回调方法的实现
var handleAudioMessage = function(message) {
    console.log(message);
    var filename = message.filename;
    var filetype = message.filetype;
    var from = message.from;

    var mestype = message.type;//消息发送的类型是群组消息还是个人消息

    var contactDivId = message.from;  //TODO to 改为 from

    var displayName = message.from;
    if (mestype == 'groupchat') {
        contactDivId = "group&-" + contactDivId;
        displayName = from;
    }

    //测试提出两条消息，注释掉处理消息0703
    //var ele = appendMsg(from, from, "收到音频" + filename + ",正在处理");
    //if (ele == null) {
    //	return;
    //}
    var options = message;
    options.onFileDownloadComplete = function(response, xhr) {

        //amr 不处理播放，提供下载
        var index = filename.lastIndexOf("\.");
        if (index > 0) {
            var fileType = filename.substring(index, filename.length);

            filename = filename.slice(0, index-1)
            if (".amr" == fileType.toLowerCase()) {

                handleFileSelect(response, function(e){
                    var samples = new AMR({
                        benchmark: true
                    }).decode(e.target.result);
                    var waveData = PCMData.encode({
                        sampleRate: 8000,
                        channelCount:   1,
                        bytesPerSample: 2,
                        data: samples
                    });

                    var url = "data:audio/wav;base64,"+btoa(waveData);
                    var li = document.createElement('div');
                    var au = document.createElement('audio');

                    au.controls = true;
                    au.src = url;
                    li.appendChild(au);
                    li.style.display = 'inline';

                    appendMsg(displayName, contactDivId, {
                        data: [
                            {
                                type: 'audio',
                                data: li
                            }
                        ]
                    });
                })
                return;
            }
        }
        var objectURL = window.URL.createObjectURL(response);
        var audio = document.createElement("audio");
        if (("src" in audio) && ("controls" in audio)) {
            audio.onload = function() {
                audio.onload = null;
                window.URL.revokeObjectURL(audio.src);
            };
            audio.onerror = function() {
                audio.onerror = null;
                appendMsg(contactDivId, contactDivId, "当前浏览器不支持播放此音频:"
                        + filename);
            };
            audio.controls = "controls";
            audio.src = objectURL;
            appendMsg(displayName, contactDivId, {
                data : [ {
                    type : 'audio',
                    filename : filename,
                    data : audio
                } ]
            });
            audio.play();
            return;
        }
    };
    options.onFileDownloadError = function(e) {
        appendMsg(contactDivId, contactDivId, e.msg + ",下载音频" + filename
                + "失败");
    };
    Easemob.xmpp.Helper.download(options);
};

var handleLocationMessage = function(message) {
    var from = message.from;
    var addr = message.addr;
    var ele = appendMsg(from, from, addr);
    return ele;
};

//显示聊天记录的统一处理方法
var appendMsg = function(who, contact, message, chattype) {
    var contactUL = document.getElementById("contactlistUL");
    if (contactUL.children.length == 0) {
        //alert("联系人列表为空，不能发消息");
        $('confirm-block-div-modal').html("联系人列表为空，不能发消息");
        return null;
    }
    var contactDivId = contact;
    if (chattype) {
        contactDivId = "group&-" + contact;
    }


    var contactLi = getContactLi(contactDivId);

    if (contactLi == null) {

        if (unknowContact[contact]) {
            return;
        }
        //alert("陌生人" + who + "的消息,忽略");
        $('confirm-block-div-modal').html("陌生人" + who + "的消息,忽略");
        unknowContact[contact] = true;
        return null;
    }

    // 消息体 {isemotion:true;body:[{type:txt,msg:ssss}{type:emotion,msg:imgdata}]}
    var localMsg = null;
    if (typeof message == 'string') {
        localMsg = Easemob.xmpp.Helper.parseTextMessage(message);
        localMsg = localMsg.body;
    } else {
        localMsg = message.data;
    }


    var date = new Date();
    var time = date.toLocaleTimeString();
    var headstr = [ "<a class='dialog-name'>" + who + "   <span></span>" + "   </a>",
                "<a class='dialog-time'>" + time + "<b></b><br/></a>" ];
    var header = $(headstr.join(''))

    var _header = document.createElement("p");
    var lineDiv = document.createElement("div");
    for ( var i = 0; i < header.length; i++) {
        var ele = header[i];
        _header.appendChild(ele);
    }
    _header.className = "dialog-header";
    lineDiv.appendChild(_header);
    var messageContent = localMsg;
    for ( var i = 0; i < messageContent.length; i++) {

        var msg = messageContent[i];
        var type = msg.type;
        var data = msg.data;
        if (type == "emotion") {
            var eletext = "<p><img src='" + data + "'/></p>";

            var ele = $(eletext);
            for ( var j = 0; j < ele.length; j++) {
                lineDiv.appendChild(ele[j]);
            }
        } else if (type == "pic") {
            var filename = msg.filename;

            var fileele = $("<p>" + filename + "</p><br>");
            for ( var j = 0; j < fileele.length; j++) {
                lineDiv.appendChild(fileele[j]);
            }

            lineDiv.appendChild(data);
        } else if (type == 'audio') {
            var filename = msg.filename;
            if(filename != undefined){
                var fileele = $("<p>" + filename + "</p><br>");
                for ( var j = 0; j < fileele.length; j++) {
                    lineDiv.appendChild(fileele[j]);
                }
            }
            lineDiv.appendChild(data);
        } else {
            var eletext = "<p>" + data + "</p>";

            var ele = $(eletext);
            ele[0].setAttribute("class", "chat-content-p3");
            ele[0].setAttribute("className", "chat-content-p3");
            if (curUserId == who) {
                ele[0].style.backgroundColor = "#EBEBEB";
            }
            for ( var j = 0; j < ele.length; j++) {
                lineDiv.appendChild(ele[j]);
            }
        }
    }
    if (contact != curChatUserId) {
        contactLi.style.backgroundColor = "green";
    }
    var msgContentDiv = getContactChatDiv(contactDivId);
    if (curUserId == who) {
        lineDiv.style.textAlign = "right";
    } else {
        lineDiv.style.textAlign = "left";
    }
    lineDiv.className = "dialog-div";

    var create = false;
    if (msgContentDiv == null) {
        msgContentDiv = createContactChatDiv(contactDivId);
        create = true;
    }
    msgContentDiv.appendChild(lineDiv);
    if (create) {
        document.getElementById(msgCardDivId).appendChild(msgContentDiv);
    }
    msgContentDiv.scrollTop = msgContentDiv.scrollHeight;
    return lineDiv;

};

var showAddFriend = function() {
    $('#addFridentModal').modal('toggle');
    $('#addfridentId').val('好友账号');//输入好友账号
    $('#add-frident-warning').html("");
};

//添加输入框鼠标焦点进入时清空输入框中的内容
var clearInputValue = function(inputId) {
    $('#' + inputId).val('');
};

var showDelFriend = function() {
    $('#delFridentModal').modal('toggle');
    $('#delfridentId').val('好友账号');//输入好友账号
    $('#del-frident-warning').html("");
};

//消息通知操作时条用的方法
var showNewNotice = function(message, from) {
    var _modal = $(_.template(modal_template, {id : from, msg: message}));
    $('#content').append(_modal);
    return _modal.modal('show');
}

//主动添加好友操作的实现方法
var startAddFriend = function() {
    var user = $('#addfridentId').val();
    if (user == '') {
        //alert("请输入好友名称");
        $('#add-frident-warning').html(
                "<font color='#FF0000'> 请输入好友名称</font>");
        return;
    }
    if (bothRoster)
        for ( var i = 0; i < bothRoster.length; i++) {
            if (bothRoster[i].name == user) {
                //alert(user + "已是您的好友");
                $('#add-frident-warning').html(
                        "<font color='#FF0000'> 已是您的好友</font>");
                return;
            }
        }
    //发送添加好友请求
    var date = new Date().toLocaleTimeString();
    conn.subscribe({
        to : user,
        message : "加个好友呗-" + date
    });
    $('#addFridentModal').modal('hide');
    return;
};

//回调方法执行时同意添加好友操作的实现方法
var agreeAddFriend = function(connection, user) {
    connection.subscribed({
        to : user,
        message : "[resp:true]"
    });
};
//拒绝添加好友的方法处理
var rejectAddFriend = function(conn, user) {
    var date = new Date().toLocaleTimeString();
    conn.unsubscribed({
        to : user,
        message : date
    });
};

//直接调用删除操作时的调用方法
var directDelFriend = function() {
    var user = $('#delfridentId').val();
    if (validateFriend(user, bothRoster)) {
        conn.removeRoster({
            to : user,
            success : function() {
                conn.unsubscribed({
                    to : user
                });
                //删除操作成功时隐藏掉dialog
                $('#delFridentModal').modal('hide');
            },
            error : function() {
                $('#del-frident-warning').html(
                        "<font color='#FF0000'>删除联系人失败!</font>");
            }
        });
    } else {
        $('#del-frident-warning').html(
                "<font color='#FF0000'>该用户不是你的好友!</font>");
    }
};
//判断要删除的好友是否在当前好友列表中
var validateFriend = function(optionuser, bothRoster) {
    for ( var deluser in bothRoster) {
        if (optionuser == bothRoster[deluser].name) {
            return true;
        }
    }
    return false;
};

//回调方法执行时删除好友操作的方法处理
var delFriend = function(connection, user) {
    conn.removeRoster({
        to : user,
        groups : [ 'default' ],
        success : function() {
            connection.unsubscribed({
                to : user
            });
        }
    });
};
//清除聊天记录
var clearCurrentChat = function clearCurrentChat() {
    var currentDiv = getContactChatDiv(curChatUserId)
            || createContactChatDiv(curChatUserId);
    currentDiv.innerHTML = "";
};

//显示成员列表
var showRoomMember = function showRoomMember() {
    queryOccupants(curRoomId);
};

//根据roomId查询room成员列表
var queryOccupants = function queryOccupants(roomId) {
    var occupants = [];
    conn.queryRoomInfo({
        roomId : roomId,
        success : function(occs) {
            if (occs) {
                for ( var i = 0; i < occs.length; i++) {
                    occupants.push(occs[i]);
                }
            }
            conn.queryRoomMember({
                roomId : roomId,
                success : function(members) {
                    if (members) {
                        for ( var i = 0; i < members.length; i++) {
                            occupants.push(members[i]);
                        }
                    }
                    showRoomMemberList(occupants);
                }
            });
        }
    });
}

var showRoomMemberList = function showRoomMemberList(occupants) {
    var membernames = [];
    for (i = 0; i < occupants.length; i++) {
        var jid = occupants[i].jid;
        var userName = jid.substring(jid.indexOf("_") + 1).split("@")[0];
        //membernames.push(jid);
        membernames.push(userName);
    }

    $('#room-member-list').text(membernames);
    $('#option-room-div-modal').modal('toggle');
};

var getObjectURL = function getObjectURL(file) {
    var url = null;
    if (window.createObjectURL != undefined) { // basic
        url = window.createObjectURL(file);
    } else if (window.URL != undefined) { // mozilla(firefox)
        url = window.URL.createObjectURL(file);
    } else if (window.webkitURL != undefined) { // webkit or chrome
        url = window.webkitURL.createObjectURL(file);
    }
    return url;
};

$(function(){
    $('#voice-record').unbind().mousedown(startRecording);
})

</script>
</head>
<body>
<div id="loginmodal" class="modal hide fade in" role="dialog"
     aria-hidden="true" data-backdrop="static">
    <div class="modal-header">
        <h3>用户登录</h3>
    </div>
    <div class="modal-body">
        <div class="control-group">
            <label for="username">用户名:</label> <input
                type="text" name="username" value="" id="username" tabindex="1" class="input-block-level" />
        </div>
        <div class="control-group">
            <label for="password">密码:</label> <input type="password" value=""
                                                     name="password" id="password" tabindex="2" class="input-block-level"/>
        </div>

    </div>
    <div class="modal-footer">
        <button class="flatbtn-blu" onclick="login()" tabindex="3">登录</button>
    </div>
</div>

<div id="waitLoginmodal" class="modal hide fade" data-backdrop="static">
    <img src="img/waitting.gif">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;正在努力加载中...</img>
</div>
<div class="content" id="content" style="display: none">
    <div class="leftcontact" id="leftcontact">
        <div id="headerimg" class="leftheader">
				<span> <img src="img/head/header2.jpg" alt="logo"
                            class="img-circle" width="60px" height="60px"
                            style="margin-top: -40px; margin-left: 20px" /></span> <span
                id="login_user"> <a class="leftheader-font"
                                    href="javascript:;"></a>
				</span> <span>
					<div class="btn-group" style="margin-left: 30px;">
                        <button class="btn btn-inverse dropdown-toggle"
                                data-toggle="dropdown">
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="javascript:showAddFriend()">添加好友</a></li>
                            <li><a href="javascript:showDelFriend()">删除好友</a></li>
                            <li class="divider"></li>
                            <li><a href="javascript:logout();">退出</a></li>
                        </ul>
                    </div>
				</span>
        </div>
        <div id="leftmiddle">
            <!--
            <input style="width: 120px; color: #999999; margin-top: 8px;"
                type="text" id="searchfriend" value="搜索"
                onFocus="if(value==defaultValue){value='';this.style.color='#000'}"
                onBlur="if(!value){value=defaultValue;this.style.color='#999'}" />
            <button id="searchFriend" style="background: #cccccc">查询</button>
        -->
        </div>
        <div id="contractlist" style="height: 490px; overflow: scroll;"></div>
    </div>
    <!-- 聊天页面 -->
    <div style="height: 78px;" id="righttop"></div>
    <div class="chatRight">
        <div id="chat01">
            <div class="chat01_title">
                <ul class="talkTo">
                    <li id="talkTo"><a href="javascript:;"></a></li>
                    <li id="recycle" style="float: right;"><img
                            src="img/recycle.png" onclick="clearCurrentChat();"
                            style="margin-right: 15px; cursor: hand; width: 18px;" title="清屏" /></li>
                    <li id="roomInfo" style="float: right;"><img
                            id="roomMemberImg"
                            src="img/head/find_more_friend_addfriend_icon.png"
                            onclick="showRoomMember();"
                            style="margin-right: 15px; cursor: hand; width: 18px; display: none"
                            title="群组成员" /></li>
                </ul>
            </div>
            <div id="null-nouser" class="chat01_content"></div>
        </div>

        <div class="chat02">
            <div class="chat02_title">
                <a class="chat02_title_btn ctb01" onclick="showEmotionDialog()"
                   href="javascript:;" title="选择表情"></a> <a
                    class="chat02_title_btn ctb03" title="选择图片"
                    onclick="showSendPic()" href="#"> </a> <a
                    class="chat02_title_btn ctb02" onclick="showSendAudio()" href="#"
                    title="选择语音"><span></span></a> <label id="chat02_title_t"></label>
                <div id="wl_faces_box" class="wl_faces_box">
                    <div class="wl_faces_content">
                        <div class="title">
                            <ul>
                                <li class="title_name">常用表情</li>
                                <li class="wl_faces_close"><span
                                        onclick='turnoffFaces_box()'>&nbsp;</span></li>
                            </ul>
                        </div>
                        <div id="wl_faces_main" class="wl_faces_main">
                            <ul id="emotionUL">
                            </ul>
                        </div>
                    </div>
                    <div class="wlf_icon"></div>
                </div>
            </div>
            <div id="input_content" class="chat02_content">
                <textarea id="talkInputId" style="resize: none;"></textarea>
            </div>
            <div class="chat02_bar">
                <p class="pull-right" style="padding: 5px;">
                    <button class="btn btn-small" type="button" id="voice-record">按我发送语音</button>
                    <button class="btn btn-small btn-primary" type="button"  onclick='sendText()'>发送</button>
                </p>
            </div>


        </div>
        <div id="fileModal" class="modal hide fade" role="dialog"
             aria-hidden="true" data-backdrop="static">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                        aria-hidden="true">&times;</button>
                <h3>文件选择框</h3>
            </div>
            <div class="modal-body">
                <input type='file' id="fileInput" /> <input type='hidden'
                                                            id="sendfiletype" />
                <div id="send-file-warning"></div>
            </div>
            <div class="modal-footer">
                <button id="fileSend" class="btn btn-primary" onclick="sendFile()">发送</button>
                <button id="cancelfileSend" class="btn" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>

    <div id="addFridentModal" class="modal hide fade" role="dialog"
         aria-hidden="true" data-backdrop="static">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"
                    aria-hidden="true">&times;</button>
            <h3>添加好友</h3>
        </div>
        <div class="modal-body">
            <input id="addfridentId" onfocus='clearInputValue("addfridentId")' />
            <div id="add-frident-warning"></div>
        </div>
        <div class="modal-footer">
            <button id="addFridend" class="btn btn-primary"
                    onclick="startAddFriend()">添加</button>
            <button id="cancelAddFridend" class="btn" data-dismiss="modal">取消</button>
        </div>
    </div>

    <div id="delFridentModal" class="modal hide fade" role="dialog"
         aria-hidden="true" data-backdrop="static">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"
                    aria-hidden="true">&times;</button>
            <h3>删除好友</h3>
        </div>
        <div class="modal-body">
            <input id="delfridentId" onfocus='clearInputValue("delfridentId")' />
            <div id="del-frident-warning"></div>
        </div>
        <div class="modal-footer">
            <button id="delFridend" class="btn btn-primary"
                    onclick="directDelFriend()">删除</button>
            <button id="canceldelFridend" class="btn" data-dismiss="modal">取消</button>
        </div>
    </div>

    <!-- 一般消息通知 -->
    <div class="alert alert-block hide" id="notice-block-div">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <div class="modal-body">
            <h4>Warning!</h4>
            <div id="notice-block-body"></div>
        </div>
    </div>

    <!-- 确认消息通知 -->
    <div id="confirm-block-div-modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
            <h3>订阅通知</h3>
        </div>
        <div class="modal-body">
            <div id="confirm-block-footer-body"></div>
        </div>
        <div class="modal-footer">
            <button id="confirm-block-footer-confirmButton"
                    class="btn btn-primary">同意</button>
            <button id="confirm-block-footer-cancelButton" class="btn"
                    data-dismiss="modal">拒绝</button>
        </div>
    </div>

    <!-- 群组消息操作界面 -->
    <div id="option-room-div-modal" class="alert modal fade hide"
         role="dialog" aria-hidden="true" data-backdrop="static">
        <button type="button" class="close" data-dismiss="modal"
                aria-hidden="true">&times;</button>
        <div class="modal-header">
            <h3>群组成员</h3>
        </div>
        <div class="modal-body">
            <div id="room-member-list"></div>
        </div>
    </div>

</div>

</body>
</html>
